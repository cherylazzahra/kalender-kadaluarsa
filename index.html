<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kalender Kadaluarsa</title>

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-dark@5/dark.css" rel="stylesheet">

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background-color: #f4f4f4; margin: 0; }
    #calendar { max-width: 900px; margin: 30px auto; background: #fff; padding: 10px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .fc-daygrid-event { display: block !important; white-space: normal !important; }
    .fc-event.expired { background-color: red !important; color: white !important; }
    .fc-event.near-expired { background-color: orange !important; color: white !important; }
    .fc-event.safe { background-color: green !important; color: white !important; }
    .controls { text-align: center; margin-bottom: 20px; }
    .btn { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; text-decoration: none; display: inline-block; }
    .btn:hover { background: #0056b3; }
    .loading { text-align: center; color: #666; }
  </style>
</head>
<body>
  <h2 style="text-align:center">ðŸ“… Kalender Tanggal Kadaluarsa</h2>
  <div class="controls">
    <a href="jadwal_kalender.xlsx" id="excelLink" class="btn" download>Unduh File Excel</a>
    <button id="showDataBtn" class="btn" style="display:none;">Tampilkan Data Excel</button>
    <input type="file" id="fileUpload" accept=".xlsx,.xls" style="display:none;">
    <button id="uploadBtn" class="btn">Upload File Excel (Jika Fetch Gagal)</button>
  </div>
  <div id="loading" class="loading" style="display:none;">Memuat data Excel...</div>
  <div id="calendar"></div>

  <script>
    const excelUrl = document.getElementById("excelLink").href;
    let calendar;
    const eventsData = {}; 
    const allExcelData = [];

    if ("Notification" in window && Notification.permission !== "granted") {
      Notification.requestPermission();
    }

    function showSystemNotification(title, body) {
      if ("Notification" in window && Notification.permission === "granted") {
        const notif = new Notification(title, { body });
        notif.onclick = () => { window.focus(); };
        setTimeout(() => notif.close(), 10000);
      }
    }

    function showAllExcelData() {
      if (allExcelData.length === 0) {
        Swal.fire({ title: 'Data Kosong', text: 'Belum ada data.', icon: 'info', background: '#222', color: '#fff' });
        return;
      }

      let html = '<table style="width:100%; border-collapse: collapse; color: white;"><tr style="background: #333;"><th>PT</th><th>Lokasi</th><th>Tanggal</th><th>Item</th></tr>';
      allExcelData.forEach(row => {
        html += `<tr style="border: 1px solid #555;"><td>${row.pt}</td><td>${row.lokasi}</td><td>${row.tanggal}</td><td>${row.item}</td></tr>`;
      });
      html += '</table>';

      Swal.fire({ title: 'Isi Data Excel', html: html, icon: 'info', background: '#222', color: '#fff', width: '90%' });
    }

    function processExcelData(buffer) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('showDataBtn').style.display = 'inline-block';
      const workbook = XLSX.read(buffer, { type: 'array' });
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const allEvents = [];
      const peringatanHariIni = [];
      const peringatanDekat = {};

      workbook.SheetNames.forEach(sheetName => {
        const worksheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
        const lokasiPT = jsonData[0]?.[0] || "Lokasi tidak diketahui";
        for (let i = 1; i < jsonData.length; i++) {
          const row = jsonData[i];
          if (!row || !row[0]) continue;
          const tanggalVal = row[0];
          const parts = [];
          for (let j = 1; j <= 12; j++) if (row[j]) parts.push(row[j]);
          const item = parts.join(" - ");
          if (!item || !tanggalVal) continue;
          let tanggal = new Date(tanggalVal);
          if (isNaN(tanggal) && typeof tanggalVal === "number") {
            const t = XLSX.SSF.parse_date_code(tanggalVal);
            tanggal = new Date(t.y, t.m - 1, t.d);
          }
          if (isNaN(tanggal)) continue;
          tanggal.setHours(12, 0, 0, 0);
          const formattedDate = tanggal.toISOString().split("T")[0];
          const diffDays = Math.floor((tanggal - today) / (1000 * 60 * 60 * 24));
          let eventClass = 'safe';
          if (diffDays <= 0) eventClass = 'expired';
          else if (diffDays <= 3) eventClass = 'near-expired';
          eventsData[formattedDate] = eventsData[formattedDate] || [];
          eventsData[formattedDate].push(item);
          allEvents.push({ title: item, start: formattedDate, allDay: true, classNames: [eventClass] });
          allExcelData.push({ pt: sheetName, lokasi: lokasiPT, tanggal: formattedDate, item });
          if (diffDays >= 0 && diffDays <= 3) {
            if (!peringatanDekat[sheetName]) peringatanDekat[sheetName] = { jumlah: 0, tanggal: new Set(), items: [] };
            peringatanDekat[sheetName].jumlah++;
            peringatanDekat[sheetName].tanggal.add(formattedDate);
            if (diffDays <= 1) peringatanHariIni.push({ pt: sheetName, tanggal: formattedDate, item });
          }
        }
      });
      calendar.removeAllEvents();
      calendar.addEventSource(allEvents);
      if (Object.keys(peringatanDekat).length > 0) Swal.fire({ title: 'Peringatan Kadaluarsa', html: 'Details', icon: 'warning', background: '#222', color: '#fff' });
      if (peringatanHariIni.length > 0) Swal.fire({ title: 'Notifikasi Hari Ini', html: peringatanHariIni.map(i => i.item).join('<br>'), icon: 'error', background: '#222', color: '#fff' });
    }

    document.addEventListener('DOMContentLoaded', function () {
      const calendarEl = document.getElementById('calendar');
      calendar = new FullCalendar.Calendar(calendarEl, { initialView: 'dayGridMonth', locale: 'id', headerToolbar: { left: 'prev,next today', center: 'title', right: '' }, dateClick: info => { if (eventsData[info.dateStr]) Swal.fire({ title: info.dateStr, html: eventsData[info.dateStr].join('<br>'), icon: 'info', background: '#222', color: '#fff' }); }, events: [] });
      calendar.render();
      document.getElementById('showDataBtn').addEventListener('click', showAllExcelData);
      document.getElementById('uploadBtn').addEventListener('click', () => document.getElementById('fileUpload').click());
      document.getElementById('fileUpload').addEventListener('change', e => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = event => processExcelData(event.target.result); reader.readAsArrayBuffer(file); } });
      document.getElementById('loading').style.display = 'block';
      fetch(excelUrl).then(res => res.arrayBuffer()).then(buffer => processExcelData(buffer)).catch(err => { document.getElementById('loading').style.display = 'none'; Swal.fire({ title: 'Error', text: err.message, icon: 'error', background: '#222', color: '#fff' }); });
    });
  </script>
</body>
</html>
